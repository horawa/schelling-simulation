#!/usr/bin/env python

# import plotly.plotly as py
import plotly.graph_objs as go
from plotly.offline import plot
import csv
import os
import sys
import string
import plotly.io as pio

path = "/Users/stas/Projects/schelling/misc/results_csv/"
files = os.listdir(path)

tolerances = ['0'] + [str(x)+'/8' for x in range(1,8)] + ['1'] #[0.125 * x for x in range(9)]

tols = [x/8 for x in range(0,9)]
# tol_pairs = [(tol1, tol2) for tol1 in tols for tol2 in tols if tol2 > tol1]
# tolerances_mut = [str(tol1)+"_"+str(tol2) for tol1, tol2 in tol_pairs]

tol_pairs_all = [(tol1, tol2) for tol1 in tols for tol2 in tols]
# tolerances_mut_all = [str(tol1)+"_"+str(tol2) for tol1, tol2 in tol_pairs_all]
tolerances_mut_all = [str(int(tol1*8))+"/8"+", "+str(int(tol2*8))+"/8" for tol1, tol2 in tol_pairs_all]
tolerances_mut_all = [T.replace("8/8","1").replace("0/8","0") for T in tolerances_mut_all]

vacancy_proportions = [x for x in range(100)] # do not use v=1.0


def get_line(T, v, pos):
	v = float(v)
	T = float(T)
	s = list()
	if "t" in pos:
		s.append(dict(type='line',
			xref='x',
			yref='y',
			x0=v-0.5,
			x1=v+0.5,
			y0=T*8+0.5,
			y1=T*8+0.5,
			yanchor='top',
			))
	if "l" in pos:
		s.append(dict(type='line',
			xref='x',
			yref='y',
			x0=v-0.5,
			x1=v-0.5,
			y0=T*8-0.5,
			y1=T*8+0.5,
			yanchor='top',
			xanchor='left'
			))
	return s

def get_line_mut(T, v, pos):
	v = float(v)
	T = [float(t)*8 for t in T.split("_")]
	Taxis = T[0]*9 + T[1]
	s = list()
	if "t" in pos:
		style = "dot" if "td" in pos else "solid"
		s.append(dict(type='line',
			xref='x',
			yref='y',
			x0=v-0.5,
			x1=v+0.5,
			y0=Taxis+0.5,
			y1=Taxis+0.5,
			yanchor='top',
			line={"dash":style},
			))
	if "l" in pos:
		style = "dot" if "ld" in pos else "solid"
		s.append(dict(type='line',
			xref='x',
			yref='y',
			x0=v-0.5,
			x1=v-0.5,
			y0=Taxis-0.5,
			y1=Taxis+0.5,
			yanchor='top',
			xanchor='left',
			line={"dash":style},
			))
	return s


for file in files:
	if file[-4:] != ".csv":
		continue


	if "mut" in file:
		# continue
		if "mut_all" in file:
			# continue
			imheight = 1150
			tolerance_list = tolerances_mut_all
			lines = ["1, 0", "7/8, 0", "6/8, 0", "5/8, 0", "4/8, 0", "3/8, 0", 
				"2/8, 0", "1/8, 0"]
		else:
			continue
			imheight = 800
			tolerance_list = tolerances_mut
			lines = ["0.875_1.0", "0.75_0.875", "0.625_0.75", "0.5_0.625", 
			"0.375_0.5", "0.25_0.375", "0.125_0.25"]


		indices = [tolerance_list.index(y) - 0.5 for y in lines]
		shapes=[
				dict(type='line',
					xref='x',
					yref='y',
					x0=-0.5,
					x1=99.5,
					y0=liney,
					y1=liney,
					yanchor='top',
					)
				for liney in indices
		]
	else:
		# continue
		tolerance_list = tolerances
		imheight = 400
		shapes = []


	name = file[:-4]
	file = path + file
	
	data = list()

	with open(file, newline='') as f:
		reader = csv.reader(f)
		try:
			for row in reader:
				data_row = [float(p) for p in row]
				data.append(data_row[:-1])
		except csv.Error as e:
			sys.exit('file {}, line {}: {}'.format(file, reader.line_num, e))

	if "satisfied_percent" in name:
		scale = 'Greens'
		reverse_scale = False
		bar_title = "← unsatisfied | satisfied →"
	else:
		scale = 'Reds'
		reverse_scale = True
		bar_title = "← segregated |   <i>Uᵣ</i>   | integrated →"

	title_font = dict(family='Serif', size=18)
	tick_font=dict(family='Serif', size=10)
	annotation_font=dict(family='Serif', size=16)


	trace = go.Heatmap(z=data,
					   x=vacancy_proportions,
					   y=tolerance_list,
					   colorscale=scale,
					   reversescale=reverse_scale,
					   colorbar=dict(
						title=bar_title,
						titleside="right",
						titlefont=title_font,
					   ),)



	annotation_data_2 = [
		(10, '2/8', ),
		(14, '2/8', ),
		(40, '2/8'),
		(2, '3/8'),
		(5, '3/8'),
		(40, '3/8'),
		(1, '5/8'),
		(10, '5/8'),
	]

	annotation_data_3 = [
		(2, '4/8'),
		(4, '4/8'),
		(25, '4/8'),
	] 

	annotation_data_4 = [
		(5, '4/8'),
		(7, '4/8'),
		(25, '4/8'),
	] 


	if name == "results4":
		annotation_data = annotation_data_4
	elif name == "results3":
		annotation_data = annotation_data_3
	elif name == "results2":
		annotation_data = annotation_data_2
	else:
		annotation_data = []

	annotations=list()

	letters = list(string.ascii_lowercase)

	for annotation_point in annotation_data:
		annotation = go.layout.Annotation(
			x=annotation_point[0],
			y=annotation_point[1],
			text='<b>'+letters.pop(0)+'</b>',
			showarrow=False,
			font=annotation_font
		)
		annotations.append(annotation)

	data_file = {
			"results2": "phase.data2",
			"satisfied_percent2": "phase.data2",
			"results3": "phase.data3",
			"satisfied_percent3": "phase.data3",
			"results4": "phase.data4",
			"satisfied_percent4": "phase.data4",
		}

	if name in data_file.keys():
		df = data_file[name]
		with open(os.path.join(path, df)) as phase_data_file:
			for data_line in phase_data_file.readlines():
				s = get_line(*data_line.split(" "))
				shapes+=s

	if "mut_all" in name:
		df = "phase.data.mut"
		with open(os.path.join(path, df)) as phase_data_file:
			for data_line in phase_data_file.readlines():
				s = get_line_mut(*data_line.split(" "))
				shapes+=s

	layout = go.Layout(
		# title=name,
		xaxis=dict(
			title='Vacancy Proportion (<i>v</i>) [%]',
			titlefont=title_font,
			tickfont=tick_font,
		),
		yaxis=dict(
			title='Agent Tolerance (<i>T</i>)',
			titlefont=title_font,
			tickfont=tick_font,
			tickmode="linear"
		),
		font=dict(family='Serif', size=12),
		annotations=annotations,
		shapes=shapes
	)

	fig = go.Figure(data=[trace], layout=layout)

	html_path = "/Users/stas/Projects/schelling/misc/results_html/"
	html_name = os.path.join(html_path, name+".html")
	png_name = name

	# plot(fig, filename=html_name, image='png', image_filename=png_name,
	# 		  image_width=800, image_height=imheight, auto_open=True)

	plot(fig, filename=html_name, auto_open=True)

	pio.write_image(fig, "/Users/Stas/Downloads/" + name + ".pdf", width=800, height=imheight)
	print(name)

